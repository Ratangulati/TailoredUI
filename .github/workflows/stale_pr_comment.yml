name: Stale PR Comment

on:
  schedule:
    - cron: '*/2 * * * *' # Runs every 2 minutes for testing purposes

jobs:
  stale-pr-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Get Open PRs
        id: get-prs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=open")
          echo "$response" | jq -c '.[] | {number: .number, updated_at: .updated_at}' > prs.json
          echo "::set-output name=prs::$(cat prs.json)"

      - name: Check for stale PRs
        id: check-stale
        run: |
          stale_prs=$(jq -r '.[] | select((now - (.updated_at | fromdateiso8601)) > (7 * 24 * 60 * 60)) | .number' prs.json)
          echo "::set-output name=stale_prs::$stale_prs"

      - name: Add stale comment
        if: ${{ steps.check-stale.outputs.stale_prs != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          for pr in ${{ steps.check-stale.outputs.stale_prs }}; do
            COMMENT="It seems there has been no activity on this PR for more than a week. Please review or provide updates."
            curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -d "{\"body\": \"$COMMENT\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$pr/comments"
          done
